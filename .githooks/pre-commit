#!/bin/bash
# Git Pre-Commit Hook: Validate lab notebook entries and enforce documentation
# This is a critical enforcement mechanism to prevent documentation fragmentation

echo "üî¨ Lab Notebook Pre-Commit Validation"

# ============================================================================
# CRITICAL CHECK 1: Detect experimental results without lab notebook entries
# ============================================================================

# Check for new or modified results/*.md files (dimension results, findings, etc.)
staged_results=$(git diff --cached --name-only --diff-filter=AM | grep "^results/.*\.md$" | grep -vE "archive/|phase1/|phase2/")

if [ -n "$staged_results" ]; then
    echo ""
    echo "‚ö†Ô∏è  EXPERIMENTAL RESULTS DETECTED IN results/"
    echo ""
    for file in $staged_results; do
        echo "   üìÑ $(basename "$file")"
    done
    echo ""
    echo "   üö® POLICY: All experimental work MUST have a lab notebook entry first"
    echo ""
    echo "   Required workflow:"
    echo "   1. Create lab-notebook/YYYY-MM/YYYYMMDD-NNN-EXPERIMENT-name.md"
    echo "   2. Document experiment in lab notebook entry"
    echo "   3. Reference detailed analysis in results/ from lab notebook"
    echo "   4. Update lab-notebook/INDEX.md"
    echo "   5. THEN commit both together"
    echo ""
    echo "   Exception: Files in results/archive/, results/phase1/, results/phase2/"
    echo "              (organized results docs) are allowed if referenced from lab notebook"
    echo ""

    # Check if there's a corresponding lab notebook entry being committed
    today=$(date +%Y%m%d)
    yesterday=$(date -v-1d +%Y%m%d)
    recent_lab_entries=$(git diff --cached --name-only --diff-filter=AM | grep -E "lab-notebook/.*/(${today}|${yesterday})-.*\.md$" | grep -v "INDEX.md")

    if [ -z "$recent_lab_entries" ]; then
        echo "   ‚ùå ERROR: No recent lab notebook entry found in this commit"
        echo ""
        echo "   Please create a lab notebook entry for this experimental work."
        echo "   See existing entries in lab-notebook/2025-10/ for examples."
        echo ""
        exit 1
    else
        echo "   ‚úÖ Found recent lab notebook entry:"
        for entry in $recent_lab_entries; do
            echo "      ‚Ä¢ $(basename "$entry")"
        done
        echo ""
        echo "   ‚ö†Ô∏è  Verify that results files are referenced in the lab notebook entry"
        echo ""
    fi
fi

# ============================================================================
# CRITICAL CHECK 2: Validate INDEX.md is updated for new entries
# ============================================================================

# Check for new lab notebook entries
new_lab_entries=$(git diff --cached --name-only --diff-filter=A | grep "^lab-notebook/.*\.md$" | grep -v "INDEX.md" | grep -v "raw-data/")

if [ -n "$new_lab_entries" ]; then
    echo ""
    echo "üìù NEW LAB NOTEBOOK ENTRIES DETECTED"
    echo ""

    # Check if INDEX.md is being updated
    if ! git diff --cached --name-only | grep -q "^lab-notebook/INDEX.md$"; then
        echo "   ‚ùå ERROR: New lab notebook entries but INDEX.md not updated"
        echo ""
        echo "   New entries:"
        for entry in $new_lab_entries; do
            echo "      ‚Ä¢ $(basename "$entry")"
        done
        echo ""
        echo "   Please update lab-notebook/INDEX.md to include these entries:"
        echo "   1. Add entry to chronological log"
        echo "   2. Update Quick Stats (Total Entries, Experiments Run)"
        echo "   3. Update Pattern Validation if applicable"
        echo "   4. Update Version History"
        echo ""
        echo "   Then stage INDEX.md: git add lab-notebook/INDEX.md"
        echo ""
        exit 1
    else
        echo "   ‚úÖ INDEX.md is being updated"

        # Verify entries are actually in INDEX.md
        for entry in $new_lab_entries; do
            entry_id=$(basename "$entry" .md)
            if git show :lab-notebook/INDEX.md 2>/dev/null | grep -q "$entry_id"; then
                echo "      ‚úÖ $entry_id found in INDEX.md"
            else
                echo "      ‚ö†Ô∏è  WARNING: $entry_id not found in staged INDEX.md"
                echo "         Make sure you added it to the Entry Log section"
            fi
        done
        echo ""
    fi
fi

# ============================================================================
# VALIDATION: Lab notebook entries follow conventions
# ============================================================================

# Check for new or modified markdown files in lab-notebook/ (exclude raw-data and INDEX.md)
staged_lab_files=$(git diff --cached --name-only --diff-filter=AM | grep "^lab-notebook/.*\.md$" | grep -v "INDEX.md" | grep -v "raw-data/")

if [ -z "$staged_lab_files" ]; then
    # No lab notebook files staged, but we already checked for results above
    exit 0
fi

echo "   Found $(echo "$staged_lab_files" | wc -l | xargs) lab notebook file(s) to validate"

validation_failed=0

for file in $staged_lab_files; do
    if [ ! -f "$file" ]; then
        continue
    fi

    basename=$(basename "$file")
    echo ""
    echo "   Validating: $basename"

    # 1. Validate naming convention
    if ! echo "$basename" | grep -qE '^[0-9]{8}-[0-9]{3}-[A-Z]+-.*\.md$'; then
        echo "   ‚ùå INVALID FILENAME FORMAT"
        echo "      Expected: YYYYMMDD-NNN-TYPE-description.md"
        echo "      Got: $basename"
        echo ""
        echo "      Valid types: EXPERIMENT, ANALYSIS, REFLECTION, CHECKPOINT,"
        echo "                   DECISION, PROTOCOL, EXTERNAL, META, SUMMARY"
        validation_failed=1
        continue
    fi

    # 2. Check for YAML frontmatter
    if ! head -1 "$file" | grep -q "^---$"; then
        echo "   ‚ùå MISSING YAML FRONTMATTER"
        echo "      File must start with '---' and include metadata"
        validation_failed=1
        continue
    fi

    # 3. Check required frontmatter fields
    missing_fields=""
    for field in "entry_id" "date" "type" "status"; do
        if ! grep -q "^$field:" "$file"; then
            missing_fields="$missing_fields $field"
        fi
    done

    if [ -n "$missing_fields" ]; then
        echo "   ‚ùå MISSING REQUIRED FRONTMATTER FIELDS:$missing_fields"
        echo "      Required: entry_id, date, type, status"
        validation_failed=1
        continue
    fi

    # 4. Validate entry_id matches filename
    entry_id=$(grep "^entry_id:" "$file" | head -1 | sed 's/entry_id: *//')
    expected_id=$(basename "$file" .md)
    if [ "$entry_id" != "$expected_id" ]; then
        echo "   ‚ö†Ô∏è  WARNING: entry_id ($entry_id) doesn't match filename ($expected_id)"
    fi

    # 5. Validate type matches filename
    type_in_frontmatter=$(grep "^type:" "$file" | head -1 | sed 's/type: *//')
    type_in_filename=$(echo "$basename" | cut -d'-' -f3)
    if [ "$type_in_frontmatter" != "$type_in_filename" ]; then
        echo "   ‚ö†Ô∏è  WARNING: type in frontmatter ($type_in_frontmatter) doesn't match filename ($type_in_filename)"
    fi

    # 6. Check if INDEX.md was updated (for new entries)
    if git diff --cached --name-only | grep -q "^lab-notebook/INDEX.md$"; then
        # INDEX.md is staged, check if this entry is in it
        entry_id_short=$(basename "$file" .md)
        if ! git show :lab-notebook/INDEX.md 2>/dev/null | grep -q "$entry_id_short"; then
            echo "   ‚ö†Ô∏è  WARNING: Entry not found in staged INDEX.md"
        fi
    else
        # INDEX.md not staged
        if git diff --cached --diff-filter=A --name-only | grep -q "^$file$"; then
            # This is a new file (Added), not modified
            echo "   ‚ö†Ô∏è  WARNING: New entry added but INDEX.md not staged"
            echo "      Remember to update lab-notebook/INDEX.md"
        fi
    fi

    echo "   ‚úÖ Validation passed"
done

if [ $validation_failed -eq 1 ]; then
    echo ""
    echo "‚ùå LAB NOTEBOOK VALIDATION FAILED"
    echo "   Please fix the errors above and try again"
    echo ""
    echo "   For help, see: lab-notebook/README.md (when created)"
    echo "   Or review: .githooks/pre-commit (this script)"
    exit 1
fi

echo ""
echo "‚úÖ All lab notebook entries validated successfully"
exit 0
